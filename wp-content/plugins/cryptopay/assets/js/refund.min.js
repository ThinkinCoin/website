($=>{$(document).ready(()=>{let firstRefundClick=!1;$("#woocommerce-order-items").on("click","button.refund-items",function(){if(!firstRefundClick){firstRefundClick=!0;let refundApiProcess;window.CryptoPayApp?.events.add("transactionReceived",async({order})=>{await refundApiProcess({refund_amount:order.amount,refundAmount:order.amount,refundPaymentAmount:order.paymentAmount}).then(()=>{cpHelpers.successPopup(CP_REFUND.lang.refundSuccessMsg).then(()=>{cpHelpers.disableScreen(),window.location.reload(),cpHelpers.waitingPopup(CryptoPayLang.redirecting)})})},"wc_refund");let startedApp;$("#woocommerce-order-items").off("click","button.do-api-refund, button.do-manual-refund"),$("#woocommerce-order-items").on("click","button.do-api-refund, button.do-manual-refund",function(e){if(e.preventDefault(),jQuery(this).is(".do-api-refund")&&!window.CryptoPayVars)return alert(CP_REFUND.lang.orderNotRefundable);function block(){$("#woocommerce-order-items").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})}if(block(),window.confirm(woocommerce_admin_meta_boxes.i18n_do_refund)){var e=$("input#refund_amount").val(),refund_reason=$("input#refund_reason").val(),refunded_amount=$("input#refunded_amount").val();if(!e)return $("#woocommerce-order-items").unblock(),window.alert(CP_REFUND.lang.refundAmountRequired);var line_item_qtys={},line_item_totals={},line_item_tax_totals={},data=($(".refund input.refund_order_item_qty").each(function(index,item){$(item).closest("tr").data("order_item_id")&&item.value&&(line_item_qtys[$(item).closest("tr").data("order_item_id")]=item.value)}),$(".refund input.refund_line_total").each(function(index,item){$(item).closest("tr").data("order_item_id")&&(line_item_totals[$(item).closest("tr").data("order_item_id")]=accounting.unformat(item.value,woocommerce_admin.mon_decimal_point))}),$(".refund input.refund_line_tax").each(function(index,item){var tax_id;$(item).closest("tr").data("order_item_id")&&(tax_id=$(item).data("tax_id"),line_item_tax_totals[$(item).closest("tr").data("order_item_id")]||(line_item_tax_totals[$(item).closest("tr").data("order_item_id")]={}),line_item_tax_totals[$(item).closest("tr").data("order_item_id")][tax_id]=accounting.unformat(item.value,woocommerce_admin.mon_decimal_point))}),{action:"woocommerce_refund_line_items",order_id:woocommerce_admin_meta_boxes.post_id,refund_amount:e,refunded_amount:refunded_amount,refund_reason:refund_reason,line_item_qtys:JSON.stringify(line_item_qtys,null,""),line_item_totals:JSON.stringify(line_item_totals,null,""),line_item_tax_totals:JSON.stringify(line_item_tax_totals,null,""),api_refund:$(this).is(".do-api-refund"),restock_refunded_items:$("#restock_refunded_items:checked").length?"true":"false",security:woocommerce_admin_meta_boxes.order_item_nonce});if(refundApiProcess=(customData={})=>new Promise(resolve=>{function filterData(handle,data){handle=$("#woocommerce-order-items").triggerHandler(`woocommerce_order_meta_box_${handle}_ajax_data`,[data]);return handle||data}data=filterData("do_refund",data),$.ajax({url:woocommerce_admin_meta_boxes.ajax_url,data:Object.assign(data,customData),type:"POST",success:function(response){!0===response.success?resolve(!0):(window.alert(response.data.error),response=filterData("reload_items",{order_id:woocommerce_admin_meta_boxes.post_id,action:"woocommerce_load_order_items",security:woocommerce_admin_meta_boxes.order_item_nonce}),block(),$.ajax({url:woocommerce_admin_meta_boxes.ajax_url,data:response,type:"POST",success:function(response){$("#woocommerce-order-items").find(".inside").empty(),$("#woocommerce-order-items").find(".inside").append(response),$("#tiptip_holder").removeAttr("style"),$("#tiptip_arrow").removeAttr("style"),$(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200,keepAlive:!0}),$(".woocommerce_order_items").stupidtable(),$(".woocommerce_order_items").on("aftertablesort",function(event,data){var th=$(this).find("th"),arrow="asc"===data.direction?"&uarr;":"&darr;",data=data.column;th.find(".wc-arrow").remove(),th.eq(data).append('<span class="wc-arrow">'+arrow+"</span>")}),$("#woocommerce-order-items").unblock()}}),$("#woocommerce-order-items").unblock())},complete:function(){window.wcTracks.recordEvent("order_edit_refunded",{order_id:data.order_id,status:$("#order_status").val(),api_refund:data.api_refund,has_reason:Boolean(data.refund_reason.length),restock:"true"===data.restock_refunded_items})}})}),window.CryptoPayVars&&CP_REFUND.refundableAmount<parseFloat(data.refund_amount)){$("#woocommerce-order-items").unblock();let msg=CP_REFUND.lang.refundAmountExceedMsg;return msg=(msg=msg.replace("{amount}",CP_REFUND.refundableAmount)).replace("{currency}",CryptoPayVars.order.currency),window.alert(msg)}data.api_refund?(CryptoPayModal.open(),$(document).on("cpModalClosed",function(){$("#woocommerce-order-items").unblock()}),e=parseFloat(data.refund_amount),e={amount:parseFloat(e),currency:CryptoPayVars.order.currency},refunded_amount={receiver:CryptoPayConfig.init.receiver,discountRates:CryptoPayConfig.discountRates},startedApp?startedApp.store.payment.setOrderParams(e):startedApp=CryptoPayApp.start(e,refunded_amount)):refundApiProcess({refundAmount:data.refund_amount}).then(()=>{window.location.reload()})}else $("#woocommerce-order-items").unblock()})}})})})(jQuery);
//# sourceMappingURL=refund.min.js.map
